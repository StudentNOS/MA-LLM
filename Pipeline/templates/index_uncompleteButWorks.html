<!DOCTYPE html>
<html>
<head>
    <title>Systematic Review Screening</title>
    <style>
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input, textarea, button, select { width: 100%; padding: 8px; }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            cursor: pointer; 
            margin-top: 10px; 
            margin-right: 10px;
        }
        button.stop {
            background: #dc3545;
        }
        .status { padding: 15px; background: #f0f0f0; margin: 20px 0; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Systematic Review Screening</h1>
        
        <form id="screening-form">
            <div class="form-group">
                <label>Entrez Email:</label>
                <input type="email" name="entrez_email" required>
            </div>
            
            <div class="form-group">
                <label>Groq API Key:</label>
                <input type="password" name="groq_api_key" required>
            </div>
            
            <div class="form-group">
                <label>Prompts Excel (XLSX):</label>
                <input type="file" name="prompts_file" accept=".xlsx" required>
            </div>
            
            <div class="form-group">
                <label>Initial PMIDs (TXT):</label>
                <input type="file" name="initial_file" accept=".txt" required>
            </div>
            
            <div class="form-group">
                <label>Goldstandard PMIDs (TXT):</label>
                <input type="file" name="goldstandard_file" accept=".txt" required>
            </div>
            
            <button type="submit">Start Screening</button>
        </form>
        
        <div id="status-container" class="status hidden">
            <h2>Processing Status</h2>
            <div id="current-status">Initializing...</div>
            <div id="controls" class="hidden">
                <button id="stop-processing" class="stop">Stop Processing</button>
                <button id="download-results">Download Results</button>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('screening-form');
        const statusContainer = document.getElementById('status-container');
        const currentStatus = document.getElementById('current-status');
        const controls = document.getElementById('controls');
        const downloadBtn = document.getElementById('download-results');
        const stopBtn = document.getElementById('stop-processing');
        
        let checkInterval;
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            statusContainer.classList.remove('hidden');
            controls.classList.add('hidden');
            currentStatus.textContent = 'Starting process...';
            
            const formData = new FormData(form);
            const response = await fetch('/run', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                controls.classList.remove('hidden');
                // Start status polling
                checkInterval = setInterval(checkStatus, 2000);
            }
        });
        
        downloadBtn.addEventListener('click', () => {
            window.location.href = '/results';
        });
        
        stopBtn.addEventListener('click', async () => {
            const response = await fetch('/stop', {
                method: 'POST'
            });
            
            const data = await response.json();
            currentStatus.textContent = data.message;
            
            if (checkInterval) {
                clearInterval(checkInterval);
            }
        });
        
        async function checkStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                
                currentStatus.textContent = data.status;
                
                // Check if processing is complete
                if (data.status.includes('Completed!') || data.status.includes('Stopped!')) {
                    clearInterval(checkInterval);
                }
            } catch (error) {
                console.error('Error checking status:', error);
            }
        }
    </script>
</body>
</html>